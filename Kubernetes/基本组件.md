[TOC]

### Kubernetes

#### å¼•è¨€

> Kuber'netes [kubÉ™'netis] - K8s: Kå’Œsä¹‹é—´æœ‰å…«ä¸ªå­—æ¯ï¼Œæ‰€ä»¥å«K8s

#### èµ„æºç®¡ç†å™¨

> åœ¨dockerå¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šå®¿ä¸»æœºå’Œå®¹å™¨è™šæ‹Ÿç«¯å£çš„æ˜ å°„ï¼Œè§
>
> ```shell
> $ docker run -d -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ --name å®¹å™¨åç§° é•œåƒçš„æ ‡è¯†ï½œé•œåƒåç§°[:tag]
> # -d:ä»£è¡¨åå°è¿è¡Œå®¹å™¨
> # -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ :ä¸ºäº†æ˜ å°„å½“å‰Linuxçš„ç«¯å£å’Œå®¹å™¨çš„ç«¯å£ï¼ˆæ¯”å¦‚æˆ‘æƒ³é€šè¿‡windowsè®¿é—®tomcatï¼Œéœ€è¦é€šè¿‡windowsè®¿é—®Linuxï¼Œå†é€šè¿‡Linuxè®¿é—®å®¹å™¨ç«¯å£ä»è€Œæ‰¾åˆ°æœ€ç»ˆè®¿é—®çš„åœ°ç‚¹ï¼‰
> # --name å®¹å™¨åç§°ï¼šæŒ‡å®šå®¹å™¨çš„åç§°
> ```
>
> é‡ç‚¹ï¼šæ¯”å¦‚æˆ‘æƒ³é€šè¿‡windowsè®¿é—®tomcatï¼Œéœ€è¦é€šè¿‡windowsè®¿é—®Linuxï¼Œå†é€šè¿‡Linuxè®¿é—®å®¹å™¨ç«¯å£ä»è€Œæ‰¾åˆ°æœ€ç»ˆè®¿é—®çš„åœ°ç‚¹
>
> ğŸŒŸdockerçš„å®¹å™¨åªèƒ½å’Œå®¿ä¸»æœºé€šä¿¡
>
> ![](./images/åŒºå—é“¾é¡¹ç›®-ç«¯å£æ˜ å°„.png)
>
> å¦‚æœåœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œå‡ ä¸ªå®¹å™¨çš„æ—¶å€™ï¼Œå®¹å™¨çš„æ˜ å°„ç®¡ç†å°±æ¯”è¾ƒå¤æ‚ã€‚æ¯”å¦‚åœ¨åŒºå—é“¾ä¸­ï¼Œè¿è¡Œä¸¤ä¸ªpeerçš„å®¹å™¨ï¼Œé‚£ä¹ˆæ˜ å°„ç«¯å£è®¿é—®çš„æ—¶å€™å°±å¼€å§‹å¤æ‚èµ·æ¥äº†ã€‚--éœ€æ±‚äº§ç”Ÿï¼šèµ„æºç®¡ç†å™¨

#### MESOS

> APACHE åˆ†å¸ƒå¼èµ„æºç®¡ç†æ¡†æ¶ï¼Œ2019-05 Twitter > Kubernetes

#### Docker Swarm

> å®ƒæ˜¯å°†ä¸€ç¾¤Dockerå®¿ä¸»æœºå˜æˆä¸€ä¸ªå•ä¸€çš„è™šæ‹Ÿä¸»æœºï¼ŒSwarmä½¿ç”¨æ ‡å‡†çš„Docker APIæ¥å£ä½œä¸ºå…¶å‰ç«¯çš„è®¿é—®å…¥å£ï¼Œæ¢è¨€ä¹‹ï¼Œå„ç§å½¢å¼çš„Docker Client(compose,docker-pyç­‰)å‡å¯ä»¥ç›´æ¥ä¸Swarmé€šä¿¡ï¼Œç”šè‡³Dockeræœ¬èº«éƒ½å¯ä»¥å¾ˆå®¹æ˜“çš„ä¸Swarmé›†æˆï¼Œè¿™å¤§å¤§æ–¹ä¾¿äº†ç”¨æˆ·å°†åŸæœ¬åŸºäºå•èŠ‚ç‚¹çš„ç³»ç»Ÿç§»æ¤åˆ°Swarmä¸Šï¼ŒåŒæ—¶Swarmå†…ç½®äº†å¯¹Dockerç½‘ç»œæ’ä»¶çš„æ”¯æŒï¼Œç”¨æˆ·ä¹Ÿå¾ˆå®¹æ˜“çš„éƒ¨ç½²è·¨ä¸»æœºçš„å®¹å™¨é›†ç¾¤æœåŠ¡ã€‚

> Docker Swarm å’Œ Docker Compose ä¸€æ ·ï¼Œéƒ½æ˜¯ Docker å®˜æ–¹å®¹å™¨ç¼–æ’é¡¹ç›®ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œ**Docker Compose æ˜¯ä¸€ä¸ªåœ¨å•ä¸ªæœåŠ¡å™¨æˆ–ä¸»æœºä¸Šåˆ›å»ºå¤šä¸ªå®¹å™¨çš„å·¥å…·**ï¼Œè€Œ **Docker Swarm åˆ™å¯ä»¥åœ¨å¤šä¸ªæœåŠ¡å™¨æˆ–ä¸»æœºä¸Šåˆ›å»ºå®¹å™¨é›†ç¾¤æœåŠ¡**ï¼Œå¯¹äºå¾®æœåŠ¡çš„éƒ¨ç½²ï¼Œæ˜¾ç„¶ Docker Swarm ä¼šæ›´åŠ é€‚åˆã€‚

> Swarm deamonåªæ˜¯ä¸€ä¸ªè°ƒåº¦å™¨(Scheduler)åŠ è·¯ç”±å™¨(router),Swarmè‡ªå·±ä¸è¿è¡Œå®¹å™¨ï¼Œå®ƒåªæ˜¯æ¥å—Dockerå®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼Œè°ƒåº¦é€‚åˆçš„èŠ‚ç‚¹æ¥è¿è¡Œå®¹å™¨ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå³ä½¿Swarmç”±äºæŸäº›åŸå› æŒ‚æ‰äº†ï¼Œé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¹Ÿä¼šç…§å¸¸è¿è¡Œï¼Œæ”¾Swarmé‡æ–°æ¢å¤è¿è¡Œä¹‹åï¼Œä»–ä¼šæ”¶é›†é‡å»ºé›†ç¾¤ä¿¡æ¯ã€‚

> Docker Swarmï¼šæ²¡æœ‰æ»šåŠ¨æ›´æ–°ã€å›æ»šæ›´æ–°ã€‚

> 2019-07 é˜¿é‡Œäº‘ å‰”é™¤ Docker Swarmä½¿ç”¨é€‰é¡¹

#### Borg

[Borgï¼šGoogleé›†ç¾¤ç®¡ç†å¤§æ€å™¨](https://blog.csdn.net/u011387521/article/details/108231931)

> Borgç³»ç»Ÿä¸»è¦ç”±ä»¥ä¸‹æ„æˆï¼š
>
> 1.ä¸€ç³»åˆ—æœºå™¨ 2.æœ¬åœ°ä¸­å¿ƒåŒ–æ§åˆ¶å™¨borgmaster 3.æ¯å°æœºå™¨ä¸Šè¿è¡Œçš„å®¢æˆ·ç«¯ borglet
>
> ![](./images/åŒºå—é“¾é¡¹ç›®-borgæ¶æ„.png)

##### borgmaster

> masterç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„RPCï¼ˆremote procedure call, è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰è¯·æ±‚ï¼Œæ”¹å˜é›†ç¾¤ä¸­çš„èµ„æºçŠ¶æ€æˆ–è€…å“åº”æ•°æ®åªè¯»è®¿é—®è¯·æ±‚ã€‚masterè¿˜è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„çŠ¶æ€(machines,task,allocs...)ï¼Œå’ŒBorgleté€šä¿¡ï¼Œæä¾›web UIã€‚
>
> åœ¨å®¹é”™ä¸Šï¼ŒBorgmasterå®é™…ä¸Šæœ‰5ä¸ªå‰¯æœ¬ï¼Œé€»è¾‘ä¸Šåªæœ‰ä¸€ä¸ªï¼Œé€šè¿‡Paxosåè®®é€‰ä¸¾é€»è¾‘ä¸Šçš„leaderã€‚ä»é€‰ä¸¾leaderåˆ°æ¢å¤æ•°æ®å¤§çº¦è¦10sã€‚masterè¿˜ä¼šæŠŠè‡ªèº«æŸæ—¶åˆ»çš„çŠ¶æ€ä½œä¸ºcheckpointå­˜å‚¨åˆ°paxos storeä¸­ã€‚

##### scheduler 

> å½“æäº¤jobæ—¶ï¼Œborgmasterå°†å®ƒè®°å½•åˆ°paxos storeä¸­ï¼Œå¹¶åŠ å…¥åˆ°taskçš„**pending queue**ã€‚schedulerä¼šæ‰«æè·å–ä»»åŠ¡ï¼Œç„¶åè°ƒåº¦åˆ°æ»¡è¶³å…¶éœ€æ±‚çš„æœºå™¨ä¸Šã€‚æ‰«æè¿‡ç¨‹æ˜¯ç›¸å¯¹å¤æ‚çš„
>
> - [ ] æ‰«æè¿‡ç¨‹ï¼šthe scan proceeds from high to low priority, modulated by a round-robin scheme within a priority to ensure fairness across users and avoid head-of-line blocking behind a large job.

> è°ƒåº¦ç®—æ³•åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
>
> 1.feasibility checkingï¼Œå¯è¡Œæ€§æ£€æŸ¥ï¼Œåˆ¤æ–­æœºå™¨æ˜¯å¦æ»¡è¶³taskçš„è¦æ±‚ 2.scoringï¼Œé€šè¿‡å¯¹æ»¡è¶³æ¡ä»¶1ä¸­çš„æœºå™¨æ‰“åˆ†ï¼Œé€‰æ‹©æœ€åˆé€‚çš„é‚£ä¸ª
>
> è¿™æ ·ä¸€æ¥ï¼Œè°ƒåº¦å™¨çš„ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤ä¸‹é¢çš„æµç¨‹ï¼š
>
> 1.ä»masteræŠ“å–çŠ¶æ€å˜æ›´ 2.æ›´æ–°æœ¬åœ°çŠ¶æ€æ‹·è´ 3.æ‰§è¡Œä»»åŠ¡è°ƒåº¦ 4.é€šçŸ¥masterè‡ªå·±çš„è°ƒåº¦æƒ…å†µ

##### borglet

> Borgleftæ˜¯æ¯ä¸ªæœºå™¨(masteré™¤å¤–)ä¸Šéƒ½è¦è¿è¡Œçš„å®¢æˆ·ç«¯ï¼Œå®ƒè´Ÿè´£ä»»åŠ¡çš„å¯åŠ¨ã€åœæ­¢ã€é‡å¯ç­‰ï¼Œè¿˜è´Ÿè´£ç®¡ç†æœºå™¨èµ„æºã€æ»šåŠ¨debugæ—¥å¿—ã€ä¸ŠæŠ¥æœºå™¨çŠ¶æ€åˆ°masterå’Œç›‘æ§ç³»ç»Ÿã€‚
>
> Borgmasterä¼šä¸»åŠ¨ä»Borgletä¸Špollsä¿¡æ¯ï¼Œpollçš„é¢‘ç‡å¯æ§åˆ¶ï¼Œè¿™æ ·Borgmasterå¯ä»¥æ§åˆ¶ç³»ç»Ÿä¸­çš„é€šä¿¡é¢‘ç‡ï¼Œé¿å…ä¸å¿…è¦çš„æµç¨‹æ§åˆ¶æœºåˆ¶ã€‚
>
> ä¸ºäº†æ€§èƒ½å’Œæ‰©å±•æ€§ï¼Œæ¯ä¸ªBorgmasterä¼šè¿è¡Œæ— çŠ¶æ€çš„å‰¯æœ¬ï¼Œè®ºæ–‡ä¸­ç§°ä¸ºlink shardï¼Œæ¥å¤„ç†ä¸€äº›ä¸Borgletçš„é€šä¿¡ã€‚åœ¨å¼¹æ€§æ–¹é¢ï¼ŒBorgletæ€»æ˜¯ä¸ŠæŠ¥æœ¬èŠ‚ç‚¹çš„å®Œæ•´ä¿¡æ¯ï¼Œlink shardä¼šå¯¹ä¸ŠæŠ¥ä¿¡æ¯è¿›è¡Œå¯¹æ¯”ï¼ŒåªæŠŠä¸åŒçš„éƒ¨åˆ†å‘é€ç»™çŠ¶æ€æœºï¼Œé™ä½masterçš„æ›´æ–°è´Ÿè½½ã€‚
>
> å½“é›†ç¾¤ä¸­çš„æœºå™¨éå¸¸å¤šæ—¶ï¼ŒBorgä¼šæŠŠborgletåˆ†å‰²ä¸ºå¤šä¸ªè¿›è¡Œï¼Œæé«˜ååé‡ã€‚

- [ ] Qï¼Ÿï¼šå½“é›†ç¾¤ä¸­çš„æœºå™¨éå¸¸å¤šæ—¶ï¼ŒBorgä¼šæŠŠborgletåˆ†å‰²ä¸ºå¤šä¸ªè¿›è¡Œï¼Œæé«˜ååé‡ã€‚

#### å¼•å…¥K8s

> Google10å¹´å‰å°±å¼€å§‹ä½¿ç”¨å®¹å™¨åŒ–çš„åŸºç¡€æ¶æ„ï¼Œå†…éƒ¨ä½¿ç”¨Borgï¼ˆåšæ ¼ï¼‰ã€‚Googleåˆ©ç”¨borgçš„è®¾è®¡æ€è·¯ï¼Œç”¨goè¯­è¨€ç¿»å†™äº†ä¸€ä¸ªç±»ä¼¼çš„èµ„æºç®¡ç†å™¨ï¼Œå³K8sã€‚Kubernetesæ€»ä½“è€Œè¨€ä½ å¯ä»¥è®¤ä¸ºæ˜¯Borgçš„ä¸€ä¸ªå¼€æºçš„ç‰ˆæœ¬ã€‚Borgåº•å±‚ç”¨çš„æ˜¯lxcçš„å®¹å™¨ï¼Œè€ŒKubernetesæ˜¯ç”¨çš„Dockerå®¹å™¨ã€‚Borgæ˜¯ç”¨C++ç¼–å†™çš„ï¼ŒKubernetesæ˜¯ç”¨Goè¯­è¨€ç¼–å†™çš„ã€‚Borgåœ¨é›†ç¾¤è°ƒåº¦çš„æ€§èƒ½ä¸Šåšäº†å¾ˆå¤šçš„ä¼˜åŒ–ï¼ŒKubernetesè¿˜æ²¡æœ‰åšéå¸¸å¤šçš„ä¼˜åŒ–ï¼Œç›®å‰ä»–åœ¨è¿™æ–¹é¢è¿˜æ˜¯æ¯”è¾ƒåœŸçš„ï¼Œåé¢è¿˜æœ‰å¾ˆå¤šå·¥ä½œéœ€è¦åšã€‚Borgçš„å•é›†ç¾¤èƒ½å¤Ÿè°ƒåº¦çš„æœºå™¨æœ‰ä¸Šä¸‡å°ï¼Œè€ŒæŒ‰Kubernetesç›®å‰åªèƒ½æ”¯æŒå‡ ç™¾å°ï¼Œè¿™æ˜¯ç›®å‰çš„æ•°æ®ã€‚

> è½»é‡çº§ï¼ˆGOç¼–è¯‘å‹è¯­è¨€å¼€å‘ï¼‰ã€å¼€æºã€å¼¹æ€§ä¼¸ç¼©ï¼ˆéœ€æ±‚å˜åŒ–çš„æ—¶å€™å¼¹æ€§å˜åŒ–èŠ‚ç‚¹ï¼‰ã€è´Ÿè½½å‡è¡¡ï¼ˆIPVSï¼‰

![](./images/åŒºå—é“¾é¡¹ç›®-K8sæ¶æ„.jpg)

##### scheduler

> è°ƒåº¦å™¨ï¼Œè´Ÿè´£æ¥å—ä»»åŠ¡ï¼Œé€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹è¿›è¡Œä»»åŠ¡åˆ†é…

##### replication controller

> å‰¯æœ¬æ§åˆ¶å™¨ã€‚ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ã€‚
>
> - [ ] å…·ä½“å‰¯æœ¬æ•°å®šä¹‰æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿå¦‚ä½•ç¡®è®¤å‰¯æœ¬æ•°æ•°ç›®ï¼Ÿå‰¯æœ¬ç”¨æ¥åšä»€ä¹ˆï¼Ÿ
>
> RCé€šè¿‡ç›‘æ§è¿è¡Œä¸­çš„Podæ¥ä¿è¯é›†ç¾¤ä¸­è¿è¡ŒæŒ‡å®šæ•°ç›®çš„Podå‰¯æœ¬ã€‚å³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„Podæ¥æ›¿ä»£ï¼›è€Œå¦‚æœå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚

> - [ ] åœ¨æ–°ç‰ˆæœ¬çš„Kubernetesä¸­å»ºè®®ä½¿ç”¨ReplicaSetæ¥å–ä»£replication controller
>
>   > ReplicaSetæ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·ï¼Œå¹¶ä¸”replicaSetæ”¯æŒé›†åˆå¼çš„selector

> è™½ç„¶ReplicaSetå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œä½†ä¸€èˆ¬è¿˜æ˜¯å»ºè®®ä½¿ç”¨Deploymentæ¥è‡ªåŠ¨ç®¡ç†ReplicaSetï¼Œè¿™æ ·å°±æ— éœ€æ‹…å¿ƒè·Ÿå…¶ä»–æœºåˆ¶çš„ä¸å…¼å®¹é—®é¢˜ï¼ˆæ¯”å¦‚ReplicaSetä¸æ”¯æŒrolling-updateä½†æ˜¯Deploymentæ”¯æŒï¼‰

##### etcd

[ä»é›¶å¼€å§‹å…¥é—¨ K8s | æ‰‹æŠŠæ‰‹å¸¦ä½ ç†è§£ etcd](https://zhuanlan.zhihu.com/p/96721097)

> etcd è¯ç”Ÿäº CoreOS å…¬å¸ï¼Œå®ƒæœ€åˆæ˜¯ç”¨äºè§£å†³é›†ç¾¤ç®¡ç†ç³»ç»Ÿä¸­ OS å‡çº§çš„åˆ†å¸ƒå¼å¹¶å‘æ§åˆ¶ä»¥åŠé…ç½®æ–‡ä»¶çš„å­˜å‚¨ä¸åˆ†å‘ç­‰é—®é¢˜ã€‚åŸºäºæ­¤ï¼Œetcd è¢«è®¾è®¡ä¸ºæä¾›é«˜å¯ç”¨ã€å¼ºä¸€è‡´çš„å°å‹ keyvalue æ•°æ®å­˜å‚¨æœåŠ¡ã€‚

> etcd æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ã€å¯é çš„ key-value å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒç”¨äºå­˜å‚¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å…³é”®æ•°æ®ï¼Œè¿™ä¸ªå®šä¹‰éå¸¸é‡è¦ã€‚

###### RAFTè§£å†³æ•…éšœ

> Raftç®—æ³•è§£å†³æ•…éšœï¼šä¸€ä¸ª etcd é›†ç¾¤ï¼Œé€šå¸¸ä¼šç”± 3 ä¸ªæˆ–è€… 5 ä¸ªèŠ‚ç‚¹ç»„æˆï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ Raft ä¸€è‡´æ€§ç®—æ³•çš„å®Œæˆåˆ†å¸ƒå¼ä¸€è‡´æ€§ååŒï¼Œç®—æ³•ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªä¸»èŠ‚ç‚¹ä½œä¸º leaderï¼Œç”± leader è´Ÿè´£æ•°æ®çš„åŒæ­¥ä¸æ•°æ®çš„åˆ†å‘ã€‚å½“ leader å‡ºç°æ•…éšœåç³»ç»Ÿä¼šè‡ªåŠ¨åœ°é€‰å–å¦ä¸€ä¸ªèŠ‚ç‚¹æˆä¸º leaderï¼Œå¹¶é‡æ–°å®Œæˆæ•°æ®çš„åŒæ­¥ã€‚å®¢æˆ·ç«¯åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸­ï¼Œä»…éœ€è¦é€‰æ‹©å…¶ä¸­çš„ä»»æ„ä¸€ä¸ªå°±å¯ä»¥å®Œæˆæ•°æ®çš„è¯»å†™ï¼Œå†…éƒ¨çš„çŠ¶æ€åŠæ•°æ®ååŒç”± etcd è‡ªèº«å®Œæˆã€‚
>
> åœ¨ etcd æ•´ä¸ªæ¶æ„ä¸­ï¼Œæœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„æ¦‚å¿µå«åš quorumï¼Œquorum çš„å®šä¹‰æ˜¯ ï¼ˆn+1ï¼‰/2ï¼Œä¹Ÿå°±æ˜¯è¯´è¶…è¿‡é›†ç¾¤ä¸­åŠæ•°èŠ‚ç‚¹ç»„æˆçš„ä¸€ä¸ªå›¢ä½“ï¼Œåœ¨ 3 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œetcd å¯ä»¥å®¹è®¸ 1 ä¸ªèŠ‚ç‚¹æ•…éšœï¼Œä¹Ÿå°±æ˜¯åªè¦æœ‰ä»»ä½• 2 ä¸ªèŠ‚ç‚¹å¯ç”¨ï¼Œetcd å°±å¯ä»¥ç»§ç»­æä¾›æœåŠ¡ã€‚åŒç†ï¼Œåœ¨ 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œåªè¦æœ‰ä»»ä½• 3 ä¸ªèŠ‚ç‚¹å¯ç”¨ï¼Œetcd å°±å¯ä»¥ç»§ç»­æä¾›æœåŠ¡ï¼Œè¿™ä¹Ÿæ˜¯ etcd é›†ç¾¤é«˜å¯ç”¨çš„å…³é”®ã€‚

[åˆ†å¸ƒå¼ç³»ç»Ÿçš„Raftç®—æ³•](https://www.jdon.com/artichect/raft.html)

[åŠ¨ç”»æ¼”ç¤ºRAFT](https://www.jdon.com/artichect/raft.html)

> Consensusï¼šæŒ‡å¤šä¸ªæœåŠ¡å™¨åœ¨çŠ¶æ€è¾¾æˆä¸€è‡´ã€‚
>
> ä½†æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå› ä¸ºå„ç§æ„å¤–å¯èƒ½ï¼Œæœ‰çš„æœåŠ¡å™¨å¯èƒ½ä¼šå´©æºƒæˆ–å˜å¾—ä¸å¯é ï¼Œå®ƒå°±ä¸èƒ½å’Œå…¶ä»–æœåŠ¡å™¨è¾¾æˆä¸€è‡´çŠ¶æ€ã€‚è¿™æ ·å°±éœ€è¦ä¸€ç§Consensusåè®®ï¼Œä¸€è‡´æ€§åè®®æ˜¯ä¸ºäº†ç¡®ä¿å®¹é”™æ€§ï¼Œä¹Ÿå°±æ˜¯å³ä½¿ç³»ç»Ÿä¸­æœ‰ä¸€ä¸¤ä¸ªæœåŠ¡å™¨å½“æœºï¼Œä¹Ÿä¸ä¼šå½±å“å…¶å¤„ç†è¿‡ç¨‹ã€‚

> ä¸ºäº†ä»¥å®¹é”™æ–¹å¼è¾¾æˆä¸€è‡´ï¼Œæˆ‘ä»¬ä¸å¯èƒ½è¦æ±‚æ‰€æœ‰æœåŠ¡å™¨100%éƒ½è¾¾æˆä¸€è‡´çŠ¶æ€ï¼Œåªè¦è¶…è¿‡åŠæ•°çš„å¤§å¤šæ•°æœåŠ¡å™¨è¾¾æˆä¸€è‡´å°±å¯ä»¥äº†ï¼Œå‡è®¾æœ‰Nå°æœåŠ¡å™¨ï¼ŒN/2 +1 å°±è¶…è¿‡åŠæ•°ï¼Œä»£è¡¨å¤§å¤šæ•°äº†ã€‚
>
> Paxoså’ŒRaftéƒ½æ˜¯ä¸ºäº†å®ç°Consensusä¸€è‡´æ€§è¿™ä¸ªç›®æ ‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å¦‚åŒé€‰ä¸¾ä¸€æ ·ï¼Œå‚é€‰è€…éœ€è¦è¯´æœå¤§å¤šæ•°é€‰æ°‘(æœåŠ¡å™¨)æŠ•ç¥¨ç»™ä»–ï¼Œä¸€æ—¦é€‰å®šåå°±è·Ÿéšå…¶æ“ä½œã€‚Paxoså’ŒRaftçš„åŒºåˆ«åœ¨äºé€‰ä¸¾çš„å…·ä½“è¿‡ç¨‹ä¸åŒã€‚

###### Term & Revisionï¼š

> Termï¼šé¦–å…ˆ etcd ä¸­æœ‰ä¸ª term çš„æ¦‚å¿µï¼Œä»£è¡¨çš„æ˜¯æ•´ä¸ªé›†ç¾¤ Leader çš„ä»»æœŸã€‚å½“é›†ç¾¤å‘ç”Ÿ Leader åˆ‡æ¢ï¼Œterm çš„å€¼å°±ä¼š +1ã€‚åœ¨èŠ‚ç‚¹æ•…éšœï¼Œæˆ–è€… Leader èŠ‚ç‚¹ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œå†æˆ–è€…æ˜¯å°†æ•´ä¸ªé›†ç¾¤åœæ­¢åå†æ¬¡æ‹‰èµ·ï¼Œéƒ½ä¼šå‘ç”Ÿ Leader çš„åˆ‡æ¢ã€‚

> Revisionï¼šç‰ˆæœ¬å·ã€‚revision ä»£è¡¨çš„æ˜¯å…¨å±€æ•°æ®çš„ç‰ˆæœ¬ã€‚å½“æ•°æ®å‘ç”Ÿå˜æ›´ï¼ŒåŒ…æ‹¬åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼Œå…¶ revision å¯¹åº”çš„éƒ½ä¼š +1ã€‚ç‰¹åˆ«çš„ï¼Œåœ¨é›†ç¾¤ä¸­è·¨ Leader ä»»æœŸä¹‹é—´ï¼Œrevision éƒ½ä¼šä¿æŒå…¨å±€å•è°ƒé€’å¢ã€‚æ­£æ˜¯ revision çš„è¿™ä¸€ç‰¹æ€§ï¼Œä½¿å¾—é›†ç¾¤ä¸­ä»»æ„ä¸€æ¬¡çš„ä¿®æ”¹éƒ½å¯¹åº”ç€ä¸€ä¸ªå”¯ä¸€çš„ revisionï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ revision æ¥æ”¯æŒæ•°æ®çš„ MVCCï¼Œä¹Ÿå¯ä»¥æ”¯æŒæ•°æ®çš„ Watchã€‚

![](./images/k8s-term&revision.jpg)

> ä»ä¸€ä¸ªæ›´å¤§çš„ç»´åº¦å»çœ‹ï¼Œå¯ä»¥å‘ç°åœ¨ term=2 å’Œ term=3 çš„ä¸¤ä¸ª Leader ä»»æœŸä¹‹é—´ï¼Œæ•°æ®å¯¹åº”çš„ revision å€¼ä¾æ—§ä¿æŒäº†å…¨å±€å•è°ƒé€’å¢ã€‚

> 1. åœ¨ etcd ä¸­æ”¯æŒå¯¹åŒä¸€ä¸ª Key å‘èµ·å¤šæ¬¡æ•°æ®ä¿®æ”¹ï¼Œæ¯æ¬¡æ•°æ®ä¿®æ”¹éƒ½å¯¹åº”ä¸€ä¸ªç‰ˆæœ¬å·ã€‚etcd åœ¨å®ç°ä¸Šè®°å½•äº†æ¯ä¸€æ¬¡ä¿®æ”¹å¯¹åº”çš„æ•°æ®ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸€ä¸ª key åœ¨ etcd ä¸­å­˜åœ¨å¤šä¸ªå†å²ç‰ˆæœ¬ã€‚
> 2. åœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™å¦‚æœä¸æŒ‡å®šç‰ˆæœ¬å·ï¼Œetcd ä¼šè¿”å› Key å¯¹åº”çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå½“ç„¶ etcd ä¹Ÿæ”¯æŒæŒ‡å®šä¸€ä¸ªç‰ˆæœ¬å·æ¥æŸ¥è¯¢å†å²æ•°æ®ã€‚
>
> ```java
> Put(key, value1); //revision = 5
> Put(key, value2); //revision = 6
> Get(key); //è¿”å›value2 (latest)
> Get(key, rev = 5); //è¿”å›value1
> ```

> ![](./images/k8s-rev & key.jpg)
>
> å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œetcd ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ä¸€ä¸ª b+tree ä¸­ï¼ˆç°è‰²ï¼‰ï¼Œè¯¥ b+tree ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œå¹¶é€šè¿‡ mmap çš„æ–¹å¼æ˜ å°„åˆ°å†…å­˜ç”¨æ¥æ”¯æŒå¿«é€Ÿçš„è®¿é—®ã€‚ç°è‰²çš„ b+tree ä¸­ç»´æŠ¤ç€ revision åˆ° value çš„æ˜ å°„å…³ç³»ï¼Œæ”¯æŒé€šè¿‡ revision æŸ¥è¯¢å¯¹åº”çš„æ•°æ®ã€‚å› ä¸º revision æ˜¯å•è°ƒé€’å¢çš„ï¼Œå½“æˆ‘ä»¬é€šè¿‡ watch æ¥è®¢é˜…æŒ‡å®š revision ä¹‹åçš„æ•°æ®æ—¶ï¼Œä»…éœ€è¦è®¢é˜…è¯¥ b+ tree çš„æ•°æ®å˜åŒ–å³å¯ã€‚
>
> åœ¨ etcd å†…éƒ¨è¿˜ç»´æŠ¤ç€å¦å¤–ä¸€ä¸ª btreeï¼ˆè“è‰²ï¼‰ï¼Œå®ƒç®¡ç†ç€ key åˆ° revision çš„æ˜ å°„å…³ç³»ã€‚å½“å®¢æˆ·ç«¯ä½¿ç”¨ key æŸ¥è¯¢æ•°æ®æ—¶ï¼Œé¦–å…ˆéœ€è¦ç»è¿‡è“è‰²çš„ btree å°† key è½¬åŒ–ä¸ºå¯¹åº”çš„ revisionï¼Œå†é€šè¿‡ç°è‰²çš„ btree æŸ¥è¯¢åˆ°å¯¹åº”çš„æ•°æ®ã€‚
>
> etcd å°†æ¯ä¸€æ¬¡ä¿®æ”¹éƒ½è®°å½•ä¸‹æ¥ä¼šå¯¼è‡´æ•°æ®æŒç»­å¢é•¿ï¼Œè¿™ä¼šå¸¦æ¥å†…å­˜åŠç£ç›˜çš„ç©ºé—´æ¶ˆè€—ï¼ŒåŒæ—¶ä¹Ÿä¼šå½±å“ b+tree çš„æŸ¥è¯¢æ•ˆç‡ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œåœ¨ etcd ä¸­ä¼šè¿è¡Œä¸€ä¸ª**å‘¨æœŸæ€§çš„ Compaction çš„æœºåˆ¶**æ¥æ¸…ç†å†å²æ•°æ®ï¼Œå°†ä¸€æ®µæ—¶é—´ä¹‹å‰çš„åŒä¸€ä¸ª Key çš„å¤šä¸ªå†å²ç‰ˆæœ¬æ•°æ®æ¸…ç†æ‰ã€‚æœ€ç»ˆçš„ç»“æœæ˜¯ç°è‰²çš„ b+tree ä¾æ—§ä¿æŒå•è°ƒé€’å¢ï¼Œä½†å¯èƒ½ä¼šå‡ºç°ä¸€äº›ç©ºæ´ã€‚

###### API

> APIï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡ etcd æä¾›çš„å®¢æˆ·ç«¯å»è®¿é—®é›†ç¾¤çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ http çš„æ–¹å¼ï¼ˆç±»ä¼¼ curl å‘½ä»¤ï¼‰ç›´æ¥è®¿é—® etcdã€‚åŒæ—¶ etcd ä¸ºäº†æ–¹ä¾¿å®¢æˆ·ç«¯å»è®¢é˜…æ•°æ®çš„å˜æ›´ï¼Œä¹Ÿæ”¯æŒäº†ä¸€ä¸ª watch æœºåˆ¶ï¼Œé€šè¿‡ watch å®æ—¶åœ°æ‹¿åˆ° etcd ä¸­æ•°æ®çš„å¢é‡æ›´æ–°ï¼Œä»è€Œå®ç°ä¸ etcd ä¸­çš„æ•°æ®åŒæ­¥ç­‰ä¸šåŠ¡é€»è¾‘ã€‚
>
> <img src="./images/k8s-etcdAPI.jpg" style="zoom: 33%;" />

###### API-watch

> watchï¼šå› ä¸º etcd å°†æ¯ä¸€æ¬¡ä¿®æ”¹éƒ½è®°å½•äº†ä¸‹æ¥ï¼Œä½¿ç”¨ watch è®¢é˜…æ•°æ®æ—¶ï¼Œå¯ä»¥æ”¯æŒä»ä»»æ„å†å²æ—¶åˆ»ï¼ˆæŒ‡å®š revisionï¼‰å¼€å§‹åˆ›å»ºä¸€ä¸ª watcherï¼Œåœ¨å®¢æˆ·ç«¯ä¸ etcd ä¹‹é—´å»ºç«‹ä¸€ä¸ªæ•°æ®ç®¡é“ï¼Œetcd ä¼šæ¨é€ä»æŒ‡å®š revision å¼€å§‹çš„æ‰€æœ‰æ•°æ®å˜æ›´ã€‚
>
> ```java
> watcher = Watch(key, rev);
> for{
>   event = watcher.Recv();
>   handle(event);
>   Â·Â·Â·
> }
> ```
>
> etcd æä¾›çš„ watch æœºåˆ¶ä¿è¯ï¼Œè¯¥ Key çš„æ•°æ®åç»­çš„è¢«ä¿®æ”¹ä¹‹åï¼Œé€šè¿‡è¿™ä¸ªæ•°æ®ç®¡é“å³æ—¶çš„æ¨é€ç»™å®¢æˆ·ç«¯ã€‚

###### API-transactions

> mini-transactionsï¼šetcd çš„ transaction æœºåˆ¶æ¯”è¾ƒç®€å•ï¼ŒåŸºæœ¬å¯ä»¥ç†è§£ä¸ºä¸€æ®µ if-else ç¨‹åºï¼Œåœ¨ if ä¸­å¯ä»¥æä¾›å¤šä¸ªæ“ä½œã€‚åœ¨ etcd å†…éƒ¨ä¼šä¿è¯æ•´ä¸ªäº‹åŠ¡æ“ä½œçš„åŸå­æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ If æ“ä½œæ‰€æœ‰çš„æ¯”è¾ƒæ¡ä»¶ï¼Œå…¶çœ‹åˆ°çš„è§†å›¾ä¸€å®šæ˜¯ä¸€è‡´çš„ã€‚åŒæ—¶å®ƒèƒ½å¤Ÿç¡®ä¿å¤šä¸ªæ“ä½œçš„åŸå­æ€§ä¸ä¼šå‡ºç° Then ä¸­çš„æ“ä½œä»…æ‰§è¡Œäº†ä¸€åŠçš„æƒ…å†µã€‚
>
> ```java
> Txn.if(
>   Compare(Value(key1), ">", "bar")), //å½“ Value(key1) å¤§äº "bar"
> 	Compare(Version(key1), "=", 2), //å¹¶ä¸” Version(key1) çš„ç‰ˆæœ¬ç­‰äº 2 
> 	Â·Â·Â·
>   ).Then(
>     Put(key2, valueX), //ä¿®æ”¹ Key2 çš„æ•°æ®ä¸º valueX
>     Delete(Key3)Â·Â·Â· //åŒæ—¶åˆ é™¤ Key3 çš„æ•°æ®
>   ).Else(
>   	Put(key2, valueY)Â·Â·Â· //Key2 ä¿®æ”¹ä¸º valueY
>   ).Commit()
> ```
>
> é€šè¿‡ etcd æä¾›çš„äº‹åŠ¡æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤šä¸ªç«äº‰ä¸­å»ä¿è¯æ•°æ®è¯»å†™çš„ä¸€è‡´æ€§ï¼Œæ¯”å¦‚è¯´å‰é¢å·²ç»æåˆ°è¿‡çš„ Kubernetes é¡¹ç›®ï¼Œå®ƒæ­£æ˜¯åˆ©ç”¨äº† etcd çš„äº‹åŠ¡æœºåˆ¶ï¼Œæ¥å®ç°å¤šä¸ª KubernetesAPI server å¯¹åŒæ ·ä¸€ä¸ªæ•°æ®ä¿®æ”¹çš„ä¸€è‡´æ€§ã€‚

###### API-lease

> lease æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€ä¸ªå¸¸è§çš„æ¦‚å¿µï¼Œç”¨äºä»£è¡¨ä¸€ä¸ªåˆ†å¸ƒå¼ç§Ÿçº¦ã€‚å…¸å‹æƒ…å†µä¸‹ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éœ€è¦å»æ£€æµ‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜æ´»çš„æ—¶ï¼Œå°±éœ€è¦ç§Ÿçº¦æœºåˆ¶ã€‚

> ![](./images/K8s-API-lease.jpg)
>
> ```java
> //åˆ›å»ºä¸€ä¸ª10sçš„ç§Ÿçº¦ï¼Œå¦‚æœåˆ›å»ºåä¸åšä»»ä½•çš„æ“ä½œï¼Œé‚£ä¹ˆ10sä¹‹åä¼šè‡ªåŠ¨è¿‡æœŸ
> leaase = CreateLease(10s);
> //å°† key1 å’Œ key2 ä¸¤ä¸ª key value ç»‘å®šåˆ°è¿™ä¸ªç§Ÿçº¦ä¹‹ä¸Š
> //è¿™æ ·å½“ç§Ÿçº¦è¿‡æœŸæ—¶ etcd å°±ä¼šè‡ªåŠ¨æ¸…ç†æ‰ key1 å’Œ key2
> //ä½¿å¾—èŠ‚ç‚¹ key1 å’Œ key2 å…·å¤‡äº†è¶…æ—¶è‡ªåŠ¨åˆ é™¤çš„èƒ½åŠ›
> Put(key1, value1, lease);
> Put(key2, value2, lease);
> //å¦‚æœå¸Œæœ›è¿™ä¸ªç§Ÿçº¦æ°¸ä¸è¿‡æœŸï¼Œéœ€è¦å‘¨æœŸæ€§çš„è°ƒç”¨ KeeyAlive æ–¹æ³•åˆ·æ–°ç§Ÿçº¦
> //Â·Â·Â·
> lease.KeepAlive();
> lease.Revoke();
> ```
>
> é€šè¿‡ç§Ÿçº¦æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼šæ¯”å¦‚è¯´éœ€è¦æ£€æµ‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦å­˜æ´»ï¼Œå¯ä»¥åœ¨è¿›ç¨‹ä¸­å»åˆ›å»ºä¸€ä¸ªç§Ÿçº¦ï¼Œå¹¶åœ¨è¯¥è¿›ç¨‹ä¸­å‘¨æœŸæ€§çš„è°ƒç”¨ KeepAlive çš„æ–¹æ³•ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¯¥èŠ‚ç‚¹çš„ç§Ÿçº¦ä¼šä¸€è‡´ä¿æŒï¼Œå¦‚æœè¿™ä¸ªè¿›ç¨‹æŒ‚æ‰äº†ï¼Œæœ€ç»ˆè¿™ä¸ªç§Ÿçº¦å°±ä¼šè‡ªåŠ¨è¿‡æœŸã€‚
>
> Multi-keyå…³è”åˆ°ä¸€ä¸ªç§Ÿçº¦ä¸Šï¼šåœ¨ etcd ä¸­ï¼Œå…è®¸å°†å¤šä¸ª key å…³è”åœ¨åŒä¸€ä¸ª lease ä¹‹ä¸Šï¼Œè¿™ä¸ªè®¾è®¡æ˜¯éå¸¸å·§å¦™çš„ï¼Œå¯ä»¥å¤§å¹…å‡å°‘ lease å¯¹è±¡åˆ·æ–°å¸¦æ¥çš„å¼€é”€ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæœ‰å¤§é‡çš„ key éƒ½éœ€è¦æ”¯æŒç±»ä¼¼çš„ç§Ÿçº¦æœºåˆ¶ï¼Œæ¯ä¸€ä¸ª key éƒ½éœ€è¦ç‹¬ç«‹çš„å»åˆ·æ–°ç§Ÿçº¦ï¼Œè¿™ä¼šç»™ etcd å¸¦æ¥éå¸¸å¤§çš„å‹åŠ›ã€‚é€šè¿‡å¤šä¸ª key ç»‘å®šåœ¨åŒä¸€ä¸ª lease çš„æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¶…æ—¶é—´ç›¸ä¼¼çš„ key èšåˆåœ¨ä¸€èµ·ï¼Œä»è€Œå¤§å¹…å‡å°ç§Ÿçº¦åˆ·æ–°çš„å¼€é”€ï¼Œåœ¨ä¸å¤±çµæ´»æ€§åŒæ—¶èƒ½å¤Ÿå¤§å¹…æé«˜ etcd æ”¯æŒçš„ä½¿ç”¨è§„æ¨¡ã€‚

###### WAL(Write Ahead Log)

[[etcd raftæ¨¡å—åˆ†æ--WALæ—¥å¿—]](https://my.oschina.net/fileoptions/blog/1825531)

[[etcd raftæ¨¡å—åˆ†æ--snapshot]](https://my.oschina.net/fileoptions/blog/1637873)

> WALï¼Œå°±æ˜¯åœ¨æ‰§è¡ŒçœŸæ­£çš„å†™æ“ä½œä¹‹å‰å…ˆå†™ä¸€ä¸ªæ—¥å¿—ã€‚å’Œå®ƒç›¸å¯¹çš„æ˜¯WBLï¼ˆwrite behind logï¼‰ã€‚è¿™äº›æ—¥å¿—éƒ½ä¼šä¸¥æ ¼ä¿è¯æŒä¹…åŒ–ï¼Œä»¥ä¿è¯æ•´ä¸ªæ“ä½œçš„ä¸€è‡´æ€§å’Œå¯æ¢å¤æ€§ã€‚
>
> ä¸RAFTæ¨¡å—å…³è”ï¼šWALä¸»è¦æ˜¯ç”¨æ¥æŒä¹…åŒ–å­˜å‚¨æ—¥å¿—çš„ï¼Œå½“raftæ¨¡å—æ”¶åˆ°ä¸€ä¸ªproposalæ—¶å°±ä¼šè°ƒç”¨Saveæ–¹æ³•å®Œæˆã€‚

> ![](./images/K8s-etcd.jpg)
>
> Entryï¼šEntryå°±è¡¨ç¤ºæäº¤çš„æ—¥å¿—æ¡ç›®äº†ï¼Œå®šä¹‰åœ¨raft.pb.goä¸­ï¼Œæˆå‘˜å¦‚ä¸‹ï¼š
>
> ```go
> // Termï¼šè¯¥æ¡æ—¥å¿—å¯¹åº”çš„Term
> // Index:æ—¥å¿—çš„ç´¢å¼•
> // Type:æ—¥å¿—çš„ç±»å‹ï¼Œæ™®é€šæ—¥å¿—å’Œé…ç½®å˜æ›´æ—¥å¿—
> // Data:æ—¥å¿—å†…å®¹
> type Entry struct {
> 	Term             uint64    `protobuf:"varint,2,opt,name=Term" json:"Term"`
> 	Index            uint64    `protobuf:"varint,3,opt,name=Index" json:"Index"`
> 	Type             EntryType `protobuf:"varint,1,opt,name=Type,enum=raftpb.EntryType" json:"Type"`
> 	Data             []byte    `protobuf:"bytes,4,opt,name=Data" json:"Data,omitempty"`
> 	XXX_unrecognized []byte    `json:"-"`
> }
> ```
>
> Snapshotï¼šåœ¨raftåè®®ä¸­ï¼Œsnapshotä¸»è¦ç”¨æ¥å‹ç¼©raftæ—¥å¿—ã€å‡å°‘raftæ—¥å¿—çš„æ•°é‡ï¼Œä¸€æ—¦æ­£ç¡®äº§ç”Ÿå¹¶æŒä¹…åŒ–äº†ä¸€ä¸ªsnapshotï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªsnapshotä¹‹å‰çš„æ—¥å¿—å…¨éƒ¨éƒ½å¯ä»¥ç›´æ¥ä¸¢æ‰ã€‚

> etcdæ˜¯ä¸€ä¸ªå¯ä¿¡èµ–çš„åˆ†å¸ƒå¼é”®å€¼æ•°æ®åº“ï¼Œå­˜å‚¨K8sé›†ç¾¤æ‰€æœ‰é‡è¦ä¿¡æ¯ï¼ˆæŒä¹…åŒ–ï¼‰
>
> - [ ] å¯ä¿¡èµ–åœ¨äºã€Œå•ç‹¬æ”¯æŒé›†ç¾¤åŒ–æ–¹æ¡ˆï¼Œä¸éœ€è¦å…¶ä»–ç»„ä»¶çš„å‚ä¸ã€
>
> ååŠ©åˆ†å¸ƒå¼é›†ç¾¤çš„æ­£å¸¸è¿è½¬ï¼šä¿å­˜åˆ†å¸ƒå¼é›†ç¾¤éœ€è¦çš„æŒä¹…åŒ–çš„é…ç½®æ–‡ä»¶å’Œé…ç½®ä¿¡æ¯
>

##### Kubelet

[io:kubelet](https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet/)

[kubelet çš„å·¥ä½œæµç¨‹](https://www.jianshu.com/p/4a068611b43e)

> kubernetes æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸Šéƒ½è¦è¿è¡Œä¸€ä¸ª worker **å¯¹å®¹å™¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†**ï¼Œè¿™ä¸ª worker ç¨‹åºå°±æ˜¯ kubeletã€‚CRI(container runtime interface, å®¹å™¨è¿è¡Œæ¥å£)ï¼Œæ“ä½œdockeråˆ›å»ºå¯¹åº”å®¹å™¨ã€‚ç›´æ¥è·Ÿå®¹å™¨å¼•æ“äº¤äº’å®ç°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
>
> ç®€å•åœ°è¯´ï¼Œkubelet çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å®šæ—¶ä»æŸä¸ªåœ°æ–¹è·å–èŠ‚ç‚¹ä¸Š pod/container çš„æœŸæœ›çŠ¶æ€ï¼ˆè¿è¡Œä»€ä¹ˆå®¹å™¨ã€è¿è¡Œçš„å‰¯æœ¬æ•°é‡ã€ç½‘ç»œæˆ–è€…å­˜å‚¨å¦‚ä½•é…ç½®ç­‰ç­‰ï¼‰ï¼Œå¹¶è°ƒç”¨å¯¹åº”çš„å®¹å™¨å¹³å°æ¥å£è¾¾åˆ°è¿™ä¸ªçŠ¶æ€ã€‚

###### å®¹å™¨ç®¡ç†

> åˆ›å»ºäº†å®¹å™¨ä¹‹åï¼Œkubelet è¿˜è¦æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¦‚æœå®¹å™¨è¿è¡Œå‡ºé”™ï¼Œå°±è¦æ ¹æ®è®¾ç½®çš„é‡å¯ç­–ç•¥è¿›è¡Œå¤„ç†ã€‚
>
> æ£€æŸ¥å®¹å™¨æ˜¯å¦å¥åº·ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼šæ‰§è¡Œå‘½ä»¤ï¼Œhttp Getï¼Œå’Œtcpè¿æ¥ã€‚
>
> ä¸ç®¡ç”¨ä»€ä¹ˆæ–¹å¼ï¼Œå¦‚æœæ£€æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œkubelet ä¼šåˆ é™¤è¯¥å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥è¿›è¡Œå¤„ç†ï¼ˆæ¯”å¦‚é‡å¯ï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸åšï¼‰ã€‚

###### å®¹å™¨ç›‘æ§

> kubelet è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„è´£ä»»ï¼Œå°±æ˜¯ç›‘æ§æ‰€åœ¨èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶å®šæ—¶å‘ master æŠ¥å‘Šã€‚çŸ¥é“æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºæƒ…å†µï¼Œå¯¹äº pod çš„è°ƒåº¦å’Œæ­£å¸¸è¿è¡Œè‡³å…³é‡è¦ã€‚
>
> kubelet ä½¿ç”¨cAdvisorè¿›è¡Œèµ„æºä½¿ç”¨ç‡çš„ç›‘æ§ã€‚cAdvisor æ˜¯ google å¼€æºçš„åˆ†æå®¹å™¨èµ„æºä½¿ç”¨å’Œæ€§èƒ½ç‰¹æ€§çš„å·¥å…·ï¼Œåœ¨ kubernetes é¡¹ç›®ä¸­è¢«é›†æˆåˆ° kubelet é‡Œï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨ localhost:4194 åœ°å€çœ‹åˆ° cAdvisor çš„ç®¡ç†ç•Œé¢ã€‚

##### Kube proxy

[Kubernetesæ ¸å¿ƒç»„ä»¶kube-proxy](https://www.cnblogs.com/kevingrace/p/6655153.html)

###### Kube-proxyä½œç”¨

> kube-proxyæ˜¯Kubernetesçš„æ ¸å¿ƒç»„ä»¶ï¼Œéƒ¨ç½²åœ¨æ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šï¼Œå®ƒæ˜¯å®ç°Kubernetes Serviceçš„é€šä¿¡ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„é‡è¦ç»„ä»¶ã€‚kube-proxyè´Ÿè´£ä¸ºPodåˆ›å»ºä»£ç†æœåŠ¡ï¼Œä»apiserverè·å–æ‰€æœ‰serverä¿¡æ¯ï¼Œå¹¶æ ¹æ®serverä¿¡æ¯åˆ›å»ºä»£ç†æœåŠ¡ï¼Œ**å®ç°serveråˆ°Podçš„è¯·æ±‚è·¯ç”±å’Œè½¬å‘**ï¼Œä»è€Œå®ç°K8så±‚çº§çš„è™šæ‹Ÿè½¬å‘ç½‘ç»œã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°**é›†ç¾¤å†…çš„å®¢æˆ·ç«¯podè®¿é—®service**ï¼Œæˆ–è€…æ˜¯**é›†ç¾¤å¤–çš„ä¸»æœºé€šè¿‡NodePortç­‰æ–¹å¼è®¿é—®service**ã€‚

> 1. kube-proxyå…¶å®å°±æ˜¯ç®¡ç†serviceçš„è®¿é—®å…¥å£ï¼ŒåŒ…æ‹¬é›†ç¾¤å†…Podåˆ°Serviceçš„è®¿é—®å’Œé›†ç¾¤å¤–è®¿é—®serviceã€‚
> 2. kube-proxyç®¡ç†seviceçš„Endpointsï¼Œ**è¯¥serviceå¯¹å¤–æš´éœ²ä¸€ä¸ªVirtual IPï¼Œä¹Ÿæˆä¸ºCluster IP**, é›†ç¾¤å†…é€šè¿‡**è®¿é—®è¿™ä¸ªCluster IP:Portå°±èƒ½è®¿é—®åˆ°é›†ç¾¤å†…å¯¹åº”çš„serivceä¸‹çš„Pod**ã€‚
> 3. serviceæ˜¯é€šè¿‡Selectoré€‰æ‹©çš„ä¸€ç»„Podsçš„æœåŠ¡æŠ½è±¡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œæä¾›äº†æœåŠ¡çš„LBå’Œåå‘ä»£ç†çš„èƒ½åŠ›ï¼Œè€Œkube-proxyçš„ä¸»è¦ä½œç”¨å°±æ˜¯è´Ÿè´£serviceçš„å®ç°ã€‚
>    - [ ] æä¾›äº†æœåŠ¡çš„LBï¼ˆLoadBalancerï¼‰å’Œåå‘ä»£ç†çš„èƒ½åŠ›?
> 4. serviceå¦å¤–ä¸€ä¸ªé‡è¦ä½œç”¨æ˜¯ï¼Œä¸€ä¸ªæœåŠ¡åç«¯çš„Podså¯èƒ½ä¼šéšç€ç”Ÿå­˜ç­äº¡è€Œå‘ç”ŸIPçš„æ”¹å˜ï¼Œserviceçš„å‡ºç°ï¼Œç»™æœåŠ¡æä¾›äº†ä¸€ä¸ªå›ºå®šçš„IPï¼Œè€Œæ— è§†åç«¯Endpointçš„å˜åŒ–ã€‚

> kubernetesè¿˜æä¾›äº†ä¸€ç§åœ¨nodeèŠ‚ç‚¹ä¸Šæš´éœ²ä¸€ä¸ªç«¯å£ï¼Œä»è€Œæä¾›ä»å¤–éƒ¨è®¿é—®serviceçš„æ–¹å¼
>
> ```go
> apiVersion: v1
> kind: Service
> metadata:
>   labels:
>     name: mysql
>     role: service
>   name: mysql-service
> spec:
>   ports:
> 	//åœ¨nodeä¸Šæš´éœ²å‡º30964ç«¯å£.
> 	//å½“è®¿é—®nodeä¸Šçš„30964ç«¯å£æ—¶ï¼Œå…¶è¯·æ±‚ä¼šè½¬å‘åˆ°serviceå¯¹åº”çš„cluster IPçš„3306ç«¯å£
> 	//å¹¶è¿›ä¸€æ­¥è½¬å‘åˆ°podçš„3306ç«¯å£ã€‚
>     - port: 
>       targetPort: 
>       nodePort: 
>   type: NodePort
>   selector:
>     mysql-service: "true"
> ```
>
> ![](./images/K8s-serviceBL.png)
>
> è®¿é—®Serviceçš„è¯·æ±‚ï¼Œä¸è®ºæ˜¯**Cluster IP+TargetPort**çš„æ–¹å¼ï¼ˆé›†ç¾¤å†…éƒ¨è®¿é—®ï¼‰ï¼›è¿˜æ˜¯ç”¨**NodeèŠ‚ç‚¹IP+NodePort**çš„æ–¹å¼ï¼ˆå¤–éƒ¨è®¿é—®ï¼‰ï¼Œéƒ½è¢«NodeèŠ‚ç‚¹çš„Iptablesè§„åˆ™é‡å®šå‘åˆ°Kube-proxyç›‘å¬ServiceæœåŠ¡ä»£ç†ç«¯å£ã€‚kube-proxyæ¥æ”¶åˆ°Serviceçš„è®¿é—®è¯·æ±‚åï¼Œæ ¹æ®è´Ÿè½½ç­–ç•¥ï¼Œè½¬å‘åˆ°åç«¯çš„Pod

###### service

> 1. åœ¨k8sä¸­ï¼Œ**æä¾›ç›¸åŒæœåŠ¡çš„ä¸€ç»„pod**å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªserviceï¼Œé€šè¿‡serviceæä¾›çš„ç»Ÿä¸€å…¥å£å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ¯ä¸ªserviceéƒ½æœ‰ä¸€ä¸ªè™šæ‹ŸIPåœ°å€ï¼ˆVIPï¼‰å’Œç«¯å£å·ä¾›å®¢æˆ·ç«¯è®¿é—®ã€‚
> 2. serviceæ˜¯ä¸€ç»„podçš„æœåŠ¡æŠ½è±¡ï¼Œç›¸å½“äºä¸€ç»„podçš„LBï¼ˆLoadBalancerï¼Œè´Ÿè½½å‡è¡¡å™¨ï¼‰ï¼Œè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™å¯¹åº”çš„podã€‚
> 3. kube-proxyå­˜åœ¨äºå„ä¸ªnodeèŠ‚ç‚¹ä¸Šï¼Œä¸»è¦ç”¨äºServiceåŠŸèƒ½çš„å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°é›†ç¾¤å†…çš„å®¢æˆ·ç«¯podè®¿é—®serviceï¼Œæˆ–è€…æ˜¯é›†ç¾¤å¤–çš„ä¸»æœºé€šè¿‡NodePortç­‰æ–¹å¼è®¿é—®service

> - [ ] å®ç°æœåŠ¡æ˜ å°„è®¿é—®ï¼Œé»˜è®¤æ“ä½œfirewall
>
>æ–°ç‰ˆæœ¬æ”¯æŒIPVS

IMPORTANTï¼šserviceå°±æ˜¯å°†æä¾›ç›¸åŒæœåŠ¡çš„podè¿›è¡Œåˆ†ç»„ï¼Œåœ¨éœ€è¦ç›¸åº”æœåŠ¡çš„podçš„æ—¶å€™ï¼Œé€šè¿‡Cluster IPé”å®šåˆ°æä¾›éœ€è¦çš„æœåŠ¡çš„serviceç»„åˆ«ä¸­ï¼Œå†é€šè¿‡TargetPortè·å–ä¸€ä¸ªpodæ¥è¿›è¡ŒæœåŠ¡ã€‚

###### serviceã€endpointsä¸podçš„å…³ç³»

![](./images/K8s-service&podå…³ç³»å›¾.png)

[k8sä¸­çš„endpoints](https://blog.csdn.net/luanpeng825485697/article/details/84296765)

> 1. serviceé€šè¿‡selectorå’Œpodå»ºç«‹å…³è”ï¼ˆé€‰æ‹©å“ªäº›podç»„æˆä¸€ä¸ªserviceç»Ÿä¸€å…¥å£ï¼Œserviceæä¾›å¯¹å¤–æä¾›æœåŠ¡çš„ç»Ÿä¸€å…¥å£cluster IPï¼‰ã€‚k8sä¼šæ ¹æ®serviceå…³è”åˆ°**podçš„podIPä¿¡æ¯ç»„åˆæˆä¸€ä¸ªendpoint**ã€‚endpointæ˜¯k8sé›†ç¾¤ä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œ**å­˜å‚¨åœ¨etcdä¸­ï¼Œç”¨æ¥è®°å½•ä¸€ä¸ªserviceå¯¹åº”çš„æ‰€æœ‰podçš„è®¿é—®åœ°å€ã€‚**
> 2. serviceé…ç½®selectorï¼Œendpoint controlleræ‰ä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„endpointå¯¹è±¡ï¼›å¦åˆ™ï¼Œä¸ä¼šç”Ÿæˆendpointå¯¹è±¡ã€‚è‹¥serviceå®šä¹‰ä¸­æ²¡æœ‰selectorå­—æ®µï¼Œserviceè¢«åˆ›å»ºæ—¶ï¼Œendpoint controllerä¸ä¼šè‡ªåŠ¨åˆ›å»ºendpointã€‚ä¾‹å¦‚ï¼Œk8sé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºk8s-classic-1113-d3çš„serviceï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ª**åŒåçš„endpointå¯¹è±¡**ã€‚
> 3. endpoint controllerï¼šendpoint controlleræ˜¯k8sé›†ç¾¤æ§åˆ¶å™¨çš„å…¶ä¸­ä¸€ä¸ªç»„ä»¶ã€‚è´Ÿè´£ç”Ÿæˆå’Œç»´æŠ¤æ‰€æœ‰endpointå¯¹è±¡çš„æ§åˆ¶å™¨ã€è´Ÿè´£ç›‘å¬serviceå’Œå¯¹åº”podçš„å˜åŒ–ã€‚
>    - ç›‘å¬åˆ°serviceè¢«**åˆ é™¤**ï¼Œåˆ™åˆ é™¤å’Œè¯¥serviceåŒåçš„endpointå¯¹è±¡ã€‚ç›‘å¬åˆ°æ–°çš„serviceè¢«**åˆ›å»º**ï¼Œåˆ™æ ¹æ®æ–°å»ºserviceä¿¡æ¯è·å–ç›¸å…³podåˆ—è¡¨ï¼Œç„¶ååˆ›å»ºå¯¹åº”endpointå¯¹è±¡ã€‚ç›‘å¬åˆ°serviceè¢«**æ›´æ–°**ï¼Œåˆ™æ ¹æ®æ›´æ–°åçš„serviceä¿¡æ¯è·å–ç›¸å…³podåˆ—è¡¨ï¼Œç„¶åæ›´æ–°å¯¹åº”endpointå¯¹è±¡ã€‚
>    - ç›‘å¬åˆ°podäº‹ä»¶ï¼Œåˆ™æ›´æ–°å¯¹åº”çš„serviceçš„endpointå¯¹è±¡ï¼Œå°†podIpè®°å½•åˆ°endpointä¸­

##### kube-proxy iptables ä¸ IPVS

[k8sä¸­çš„endpoints](https://blog.csdn.net/luanpeng825485697/article/details/84296765)

[Kubernetesæ ¸å¿ƒç»„ä»¶kube-proxy](https://www.cnblogs.com/kevingrace/p/6655153.html)

#### Pod

> åœ¨ä¼ ç»Ÿdockerä¸­ï¼Œæ¯ä¸€ä¸ªdockerå®¹å™¨éƒ½æ˜¯ç‹¬ç«‹å­˜åœ¨ï¼Œéƒ½æœ‰å„è‡ªçš„ipåœ°å€ï¼ŒæŒ‚è½½å·ç­‰ç­‰ã€‚æœ‰äº›å®¹å™¨çš„å…³ç³»åº”è¯¥èƒ½å¤Ÿç›´æ¥äº’ç›¸â€œè§é¢â€ï¼ˆlocalhostè®¿é—®ï¼‰ã€‚ä¾‹å¦‚åŒºå—é“¾æŸä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è®¿é—®ï¼Œå¦‚æœå¯ä»¥localhostè®¿é—®ä¼šååˆ†ä¾¿æ·ã€‚--K8så®šä¹‰äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼špod

> åœ¨ kubernetes çš„è®¾è®¡ä¸­ï¼Œæœ€åŸºæœ¬çš„ç®¡ç†å•ä½æ˜¯ podï¼Œè€Œä¸æ˜¯ containerã€‚pod æ˜¯ kubernetes åœ¨å®¹å™¨ä¸Šçš„ä¸€å±‚å°è£…ï¼Œç”±ä¸€ç»„è¿è¡Œåœ¨åŒä¸€ä¸»æœºçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ç»„æˆã€‚å¦‚æœæŠŠå®¹å™¨æ¯”å–»æˆä¼ ç»Ÿæœºå™¨ä¸Šçš„ä¸€ä¸ªè¿›ç¨‹ï¼ˆå®ƒå¯ä»¥æ‰§è¡Œä»»åŠ¡ï¼Œå¯¹å¤–æä¾›æŸç§åŠŸèƒ½ï¼‰ï¼Œé‚£ä¹ˆ pod å¯ä»¥ç±»æ¯”ä¸ºä¼ ç»Ÿçš„ä¸»æœºï¼šå®ƒåŒ…å«äº†å¤šä¸ªå®¹å™¨ï¼Œä¸ºå®ƒä»¬æä¾›å…±äº«çš„ä¸€äº›èµ„æºã€‚
>
> ä¹‹æ‰€ä»¥è´¹åŠŸå¤«æä¾›è¿™ä¸€å±‚å°è£…ï¼Œä¸»è¦æ˜¯å› ä¸ºå®¹å™¨æ¨èçš„ç”¨æ³•æ˜¯é‡Œé¢åªè¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œä¸€èˆ¬æƒ…å†µä¸‹æŸä¸ªåº”ç”¨éƒ½ç”±å¤šä¸ªç»„ä»¶æ„æˆçš„ã€‚
>
> pod ä¸­æ‰€æœ‰çš„å®¹å™¨æœ€å¤§çš„ç‰¹æ€§ä¹Ÿæ˜¯æœ€å¤§çš„å¥½å¤„å°±æ˜¯å…±äº«äº†å¾ˆå¤šèµ„æºï¼Œæ¯”å¦‚ç½‘ç»œç©ºé—´ã€‚pod ä¸‹æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œå’Œç«¯å£ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬ä¹‹é—´å¯ä»¥é€šè¿‡ localhost è®¿é—®å’Œé€šä¿¡ï¼Œå¯¹å¤–çš„é€šä¿¡æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œçœå»äº†å¾ˆå¤šå®¹å™¨é€šä¿¡çš„éº»çƒ¦ã€‚
>
> é™¤äº†ç½‘ç»œä¹‹å¤–ï¼Œå®šä¹‰åœ¨ pod é‡Œçš„ volume ä¹Ÿå¯ä»¥ mount åˆ°å¤šä¸ªå®¹å™¨é‡Œï¼Œä»¥å®ç°å…±äº«çš„ç›®çš„ã€‚
>
> æœ€åï¼Œå®šä¹‰åœ¨ pod çš„èµ„æºé™åˆ¶ï¼ˆæ¯”å¦‚ CPU å’Œ Memoryï¼‰ ä¹Ÿæ˜¯æ‰€æœ‰å®¹å™¨å…±äº«çš„ã€‚

> podåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œå°±ä¼šç«‹å³å¯åŠ¨ä¸€ä¸ªå«åšPAUSEçš„å®¹å™¨ã€‚PAUSEå®¹å™¨å°±æ˜¯ä¸€ä¸ªå…±äº«å®¹å™¨ã€‚
>
> å…±äº«ç½‘ç»œæ ˆï¼špodå†…å°è£…å‡ ä¸ªå®¹å™¨ï¼ŒåŒä¸€ä¸ªpodå†…çš„å®¹å™¨å…±äº«ä¸€ä¸ªç½‘ç»œæ ˆï¼Œç›¸å½“äºæœ¬åœ°ç½‘ç»œï¼Œå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡localhostè®¿é—®ã€‚
>
> å…±äº«å­˜å‚¨å·ï¼šï¼Ÿ

##### RS- ReplicaSet

å‚è§ä¸Šé¢çš„RC - Replication Controller

##### HPA - Horizontal Pod Autoscaling

> HPAä»…é€‚ç”¨äºDeploymentå’ŒRSã€‚åœ¨V1ç‰ˆæœ¬çš„æ—¶å€™ä»…æ”¯æŒæ ¹æ®Podçš„CPUåˆ©ç”¨ç‡æ‰©ç¼©å®¹ï¼Œåœ¨ v1-alphaç‰ˆæœ¬ä¸­ï¼Œæ”¯æŒæ ¹æ®å†…å­˜å’Œç”¨æˆ·è‡ªå®šä¹‰çš„metricæ‰©ç¼©å®¹ã€‚

> å®ç°å¼¹æ€§ä¼¸ç¼©ã€‚æ¯”å¦‚è§„åˆ™è¦æ±‚ï¼ˆCUP > 80  MAX 10 MIN 2ï¼‰

##### StatefulSet

> RSå’ŒDeploymentæ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡
>
> StatefulSetæ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜

> åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š
>
> 1.ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ã€‚å³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäºPVCæ¥å®ç°ã€‚ã€
>
> - [x] æŒä¹…åŒ–å­˜å‚¨æ•°æ®ã€‚æ¯”å¦‚æŸä¸€ä¸ªPODåœ¨æ€æ­»ä¹‹åï¼Œç„¶ååœ¨è°ƒåº¦å›æ¥ï¼Œè°ƒåº¦ä¸€ä¸ªæ–°çš„Podå»å–ä»£çš„æ—¶å€™ï¼Œå®ƒçš„å­˜å‚¨ç”¨åˆ°çš„ä¾ç„¶è¿˜æ˜¯ä¹‹å‰çš„å­˜å‚¨ï¼Œå¹¶ä¸”é‡Œé¢çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚
>
> 2.ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ã€‚å³Podé‡æ–°è°ƒåº¦åèµ·PodNameå’ŒHostNameä¸å˜ï¼ŒåŸºäºHeadless Serviceï¼ˆå³æ²¡æœ‰Cluster IPçš„Serviceï¼‰æ¥å®ç°ã€‚
>
> - [x] ç½‘ç»œæ ‡è¯†ã€‚ä¹‹å‰çš„Podåã€ä¸»æœºåéƒ½ä¾ç„¶è¢«ç»§æ‰¿äº†ä¸‹æ¥ã€‚é˜²æ­¢åœ¨é›†ç¾¤è°ƒåº¦çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºæ–°çš„podå–ä»£äº†æ—§podçš„æ—¶å€™åå­—çš„å˜åŒ–ï¼Œéœ€è¦é‡æ–°å†™å…¥
>
> 3.æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‹“å±•ã€‚å³Podæ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‹“å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡è¿›è¡Œï¼ˆå³ä»0 - N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ªPodè¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„Podå¿…é¡»éƒ½æ˜¯Runningå’ŒReadyçŠ¶æ€ï¼‰ï¼ŒåŸºäºinit containersæ¥å®ç°

##### DaemonSet

> DaemonSetç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…ä¸€äº›ï¼‰Nodeä¸Šè¿è¡Œä¸€ä¸ªPodå‰¯æœ¬ã€‚å½“æœ‰NodeåŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ªPodã€‚å½“æœ‰Nodeä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº›Podä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤daemonSetå°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰Podã€‚
>
> - [ ] Nodeè¿è¡Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªPodï¼Ÿåç»­ç¡®è®¤ã€‚
>
>   > å¦‚æœéœ€è¦ä½¿ç”¨daemonSetå»æ‰§è¡Œä¸åŒçš„ä¸‰ä¸ªè¿›ç¨‹Podï¼Œå¯ä»¥æ•´3ä¸ªdaemonSetï¼Œä¹Ÿå¯ä»¥æå–è¿™ä¸‰ä¸ªä¸»è¦è¿›ç¨‹ä½œä¸ºå®¹å™¨æ”¾åœ¨åŒä¸€ä¸ªPodé‡Œã€‚

> - [ ] ä½¿ç”¨DaemonSetçš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼šï¼ˆåç»­æ·±å…¥äº†è§£ï¼‰
>
>   > 1.è¿è¡Œé›†ç¾¤å­˜å‚¨daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œglustcrdã€ccph
>   >
>   > 2.åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†daemonï¼Œä¾‹å¦‚fluentdã€logstash
>   >
>   > 3.åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œç›‘æ§daemonï¼Œä¾‹å¦‚Prometheus Node Exporter

